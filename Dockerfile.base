# QEMU ARM64 Builder/Emulator
# Enables running and building aarch64 binaries on x86_64 via QEMU user-mode emulation
FROM debian:bookworm-slim
ENV DEBIAN_FRONTEND=noninteractive
USER root


RUN apt-get update && apt-get install -y --no-install-recommends \
    debootstrap \
    fakeroot \
    qemu-user-static \
    binfmt-support \
    && rm -rf /var/lib/apt/lists/*


# Register binfmt for aarch64 (qemu-user-static auto-registers; ensure enabled)
RUN update-binfmts --enable qemu-aarch64 2>/dev/null || true

# Stage 1: debootstrap --foreign (downloads packages for arm64)
RUN fakeroot -s .fakeroot.state debootstrap --arch=arm64 --foreign bookworm /chroot http://deb.debian.org/debian/

RUN mkdir -p /chroot/usr/bin
RUN cp /usr/bin/qemu-aarch64-static /chroot/usr/bin

RUN echo ':qemu-aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-aarch64-static:F' | tee /proc/sys/fs/binfmt_misc/register || true

# Stage 2: debootstrap --second-stage (fakeroot avoids mount permission errors)
RUN fakeroot -i .fakeroot.state -s .fakeroot.state chroot /chroot /debootstrap/debootstrap --second-stage
RUN test -f /chroot/bin/bash || (echo "ERROR: debootstrap second-stage failed - /bin/bash not found" && exit 1)

RUN chroot /chroot apt-get update
RUN chroot /chroot apt-get install -y --no-install-recommends \
    autoconf \
    autoconf-archive \
    automake \
    binutils \
    bison \
    build-essential \
    ca-certificates \
    curl \
    debhelper \
    debmake \
    flex \
    g++ \
    gcc \
    git \
    gnupg \
    libdbus-1-dev \
    libdrm-dev \
    libegl1-mesa-dev \
    libglu1-mesa-dev \
    libgtest-dev \
    libiptc-dev \
    libsystemd-dev \
    libtool \
    libudev-dev \
    libx11-dev \
    libx11-xcb-dev \
    libcurl4-openssl-dev \
    libxext-dev \
    libxi-dev \
    libxkbcommon-dev \
    libxkbcommon-x11-dev \
    libxrandr-dev \
    libxrender-dev \
    libxss-dev \
    libxtables-dev \
    linux-libc-dev \
    lsb-release \
    make \
    meson \
    ninja-build \
    pkg-config \
    python3-distutils \
    python3-jinja2 \
    software-properties-common \
    tar \
    unzip \
    wget \
    zip \
    '^libxcb.*-dev' \
    && chroot /chroot rm -rf /var/lib/apt/lists/*
